<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM Vacantes ‚Äî Supabase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{color-scheme:light}
    body{
      background:
        radial-gradient(1000px 700px at -10% -20%, #dbeafe 0, transparent 60%),
        radial-gradient(1200px 700px at 110% 0%, #e0e7ff 0, transparent 60%),
        #f6f9fc;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    .hero { background: linear-gradient(180deg,#2563eb,#1e3a8a); border-radius: 18px; color:#fff; padding:24px; box-shadow:0 14px 30px rgba(2,6,23,.15) }
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 14px 30px rgba(2,6,23,.08)}
    .input{width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:12px;background:#fff}
    .btn{padding:12px 14px;border:1px solid #cbd5e1;border-radius:12px;background:linear-gradient(#ffffff,#eef2ff);box-shadow:0 6px 0 #c7d2fe;transform:translateY(0);transition:.15s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 7px 0 #c7d2fe}
    .btn:active{transform:translateY(1px);box-shadow:0 4px 0 #c7d2fe}
    .btn-primary{padding:12px 14px;border-radius:12px;background:linear-gradient(180deg,#1e40af,#0f172a);color:#fff;box-shadow:0 6px 0 #0b1223;border:1px solid #0b1223}
    .chip{display:inline-block;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#f8fafc;font-size:12px}
    .secure {background:linear-gradient(90deg,#e0f2fe,#e0e7ff);border:1px solid #bfdbfe}
    .calendar{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:6px}
    .cal-head,.cal-cell{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;min-height:62px}
    .cal-head{font-weight:600;text-align:center;background:#f8fafc}
    .cal-cell .d{font-weight:600}
    .cal-cell.disabled{opacity:.35;pointer-events:none}
    .cal-cell.clickable{cursor:pointer;outline:2px solid transparent}
    .cal-cell.clickable:hover{outline-color:#2563eb}
    .cal-cell.selected{outline:2px solid #1e40af;background:#eef2ff}
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <div class="hero mb-6">
      <h1 class="text-3xl font-bold">CRM Vacantes ‚Äî Supabase</h1>
      <p class="opacity-90">Gesti√≥n de disponibilidad y asignaciones de personal</p>
    </div>

    <div class="flex items-center justify-between mb-4">
      <div class="text-sm secure px-3 py-1 rounded-lg">üîí Tus datos est√°n seguros (Auth + RLS)</div>
      <div id="userBox" class="hidden items-center gap-3">
        <button id="btnProfile" type="button" class="btn">Mis datos</button>
        <span id="userName" class="chip"></span>
        <button id="logoutBtn" type="button" class="btn">Salir</button>
      </div>
    </div>

    <!-- AUTH -->
    <section id="auth" class="card p-6">
      <h2 class="text-xl font-semibold mb-2">Ingresar</h2>
      <p class="text-slate-600 mb-4">Cre√° tu usuario o inici√° sesi√≥n con email y contrase√±a.</p>
      <form class="grid md:grid-cols-2 gap-3">
        <input id="email" type="email" placeholder="Email" class="input" required />
        <input id="password" type="password" placeholder="Contrase√±a" class="input" required />
        <button id="signInBtn" class="btn-primary"><span class="inline-block mr-1">üîê</span>Ingresar</button>
        <button id="showSignup" type="button" class="btn">Crear cuenta</button>
      </form>
      <p id="authMsg" class="mt-3 text-sm"></p>

      <!-- REGISTRO AMPLIADO -->
      <div id="signupCard" class="hidden mt-6 border-t pt-6">
        <h3 class="font-semibold mb-2">Datos del postulante</h3>
        <div class="grid md:grid-cols-3 gap-3">
          <input id="su_fullname" class="input" placeholder="Nombre y apellido" />
          <input id="su_dni" class="input" placeholder="DNI" />
          <input id="su_cuil" class="input" placeholder="CUIL" />
          <input id="su_phone" class="input" placeholder="Tel√©fono" />
          <input id="su_address" class="input" placeholder="Direcci√≥n" />
          <input id="su_city" class="input" placeholder="Ciudad" />
          <input id="su_email" class="input md:col-span-2" placeholder="Email (para crear usuario)" />
          <input id="su_pass" type="password" class="input" placeholder="Contrase√±a" />
          <textarea id="su_notes" class="input md:col-span-3" rows="2" placeholder="Notas (opcional)"></textarea>
        </div>
        <div class="mt-3">
          <button id="signUpBtn" class="btn-primary">Crear cuenta</button>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="hidden">
      <nav class="flex flex-wrap gap-2 mb-4">
        <button data-tab="worker"          class="tab btn">Solicitar d√≠as</button>
        <button data-tab="myassign"        class="tab btn">Mis asignaciones</button>
        <button data-tab="profile"         class="tab btn">Mis datos</button>
        <button data-tab="admin-req"       class="tab btn hidden" id="btnTabReq">Solicitudes (Admin)</button>
        <button data-tab="admin-assign"    class="tab btn hidden" id="btnTabAdmin">Asignaciones (Admin)</button>
        <button data-tab="general"         class="tab btn hidden" id="btnTabGeneral">Calendario general</button>
      </nav>

      <!-- WORKER: DOS CALENDARIOS -->
      <div id="tab-worker" class="card p-6 hidden">
        <h2 class="text-lg font-semibold mb-2">Seleccion√° d√≠as y turnos</h2>
        <p class="text-slate-600 mb-3">Tild√° los d√≠as en cada sede. Eleg√≠ turno y luego ‚ÄúSolicitar d√≠as‚Äù.</p>

        <div class="grid lg:grid-cols-2 gap-6">
          <!-- Rivadavia -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-medium">Av. Rivadavia 1745</h3>
              <div class="flex items-center gap-2">
                <label class="chip"><input type="radio" name="sh1" value="07-19" class="mr-1" checked/>07‚Äì19</label>
                <label class="chip"><input type="radio" name="sh1" value="19-07" class="mr-1"/>19‚Äì07</label>
              </div>
            </div>
            <div class="flex items-center gap-2 mb-2">
              <button class="btn" id="cal1Prev" type="button">‚Üê</button>
              <div id="cal1Title" class="font-medium"></div>
              <button class="btn" id="cal1Next" type="button">‚Üí</button>
            </div>
            <div id="cal1" class="calendar"></div>
          </div>

          <!-- Yrigoyen -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-medium">Hip√≥lito Yrigoyen 1236</h3>
              <div class="flex items-center gap-2">
                <label class="chip"><input type="radio" name="sh2" value="07-19" class="mr-1" checked/>07‚Äì19</label>
                <label class="chip"><input type="radio" name="sh2" value="19-07" class="mr-1"/>19‚Äì07</label>
              </div>
            </div>
            <div class="flex items-center gap-2 mb-2">
              <button class="btn" id="cal2Prev" type="button">‚Üê</button>
              <div id="cal2Title" class="font-medium"></div>
              <button class="btn" id="cal2Next" type="button">‚Üí</button>
            </div>
            <div id="cal2" class="calendar"></div>
          </div>
        </div>

        <div class="mt-4 flex items-center gap-3">
          <button id="btnSolicitar" class="btn-primary" type="button">Solicitar d√≠as</button>
          <span class="text-sm text-slate-600" id="selResume">‚Äî</span>
        </div>
      </div>

      <!-- MIS ASIGNACIONES -->
      <div id="tab-myassign" class="card p-6 hidden">
        <h2 class="text-lg font-semibold mb-4">Mis asignaciones</h2>
        <table class="w-full text-sm">
          <thead><tr class="text-left"><th class="py-2">Fecha</th><th>Ubicaci√≥n</th><th>Turno</th><th>Estado</th></tr></thead>
          <tbody id="myAssign"></tbody>
        </table>
      </div>

      <!-- MIS DATOS -->
      <div id="tab-profile" class="card p-6 hidden">
        <h2 class="text-lg font-semibold mb-4">Mis datos</h2>
        <div class="grid md:grid-cols-3 gap-3">
          <input id="pf_full_name"  class="input" placeholder="Nombre y apellido" />
          <input id="pf_dni"        class="input" placeholder="DNI" />
          <input id="pf_lp"         class="input" placeholder="LP" />
          <input id="pf_dep_code"   class="input" placeholder="C√≥digo de dependencia" />
          <input id="pf_jerarquia"  class="input" placeholder="Jerarqu√≠a" />
          <input id="pf_horario"    class="input" placeholder="Horario ordinario (ej: 08-16)" />
          <input id="pf_phone"      class="input" placeholder="Tel√©fono" />
          <input id="pf_address"    class="input" placeholder="Direcci√≥n" />
          <input id="pf_city"       class="input" placeholder="Ciudad" />
          <textarea id="pf_notes"   class="input md:col-span-3" rows="2" placeholder="Notas"></textarea>
        </div>
        <div class="mt-3">
          <button id="btnSaveProfile" class="btn-primary" type="button">Guardar mis datos</button>
        </div>
      </div>

      <!-- ADMIN: SOLICITUDES -->
      <div id="tab-admin-req" class="card p-6 hidden">
        <h2 class="text-lg font-semibold mb-4">Solicitudes del personal</h2>
        <div class="grid md:grid-cols-6 gap-3 mb-4">
          <input id="rqFrom" type="date" class="input" />
          <input id="rqTo" type="date" class="input" />
          <select id="rqLocation" class="input"></select>
          <select id="rqShift" class="input">
            <option value="">(Todos)</option>
            <option value="07-19">07‚Äì19</option>
            <option value="19-07">19‚Äì07</option>
          </select>
          <input id="rqSearch" class="input" placeholder="Buscar por nombre‚Ä¶" />
          <button id="btnRqLoad" class="btn" type="button">Actualizar</button>
        </div>
        <div class="mb-3 text-sm" id="rqResume">‚Äî</div>
        <table class="w-full text-sm">
          <thead><tr class="text-left"><th class="py-2">Fecha</th><th>Nombre</th><th>Ubicaci√≥n</th><th>Turno</th></tr></thead>
          <tbody id="rqTable"></tbody>
        </table>
        <div class="mt-3">
          <button id="btnRqExport" class="btn" type="button">Exportar CSV</button>
        </div>
      </div>

      <!-- ADMIN: ASIGNACIONES -->
      <div id="tab-admin-assign" class="card p-6 hidden">
        <h2 class="text-lg font-semibold mb-4">Asignaciones (Admin)</h2>
        <div class="grid md:grid-cols-5 gap-3 mb-4">
          <input id="admDay" type="date" class="input" />
          <select id="admLocation" class="input"></select>
          <select id="admShift" class="input">
            <option value="07-19">07‚Äì19</option>
            <option value="19-07">19‚Äì07</option>
          </select>
          <button id="btnLoadPool" class="btn" type="button">Ver solicitudes</button>
          <button id="btnExport" class="btn" type="button">Exportar CSV (d√≠a)</button>
        </div>

        <div id="capacityBox" class="mb-4"></div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-medium mb-2">Candidatos</h3>
            <table class="w-full text-sm">
              <thead><tr class="text-left"><th class="py-2">Persona</th><th></th></tr></thead>
              <tbody id="pool"></tbody>
            </table>
          </div>
          <div>
            <h3 class="font-medium mb-2">Asignados</h3>
            <table class="w-full text-sm">
              <thead><tr class="text-left"><th class="py-2">Persona</th><th>Estado</th><th></th></tr></thead>
              <tbody id="assigned"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CALENDARIO GENERAL (ADMIN) -->
      <div id="tab-general" class="card p-6 hidden">
        <h2 class="text-lg font-semibold mb-2">Calendario general (solicitudes del personal)</h2>
        <div class="flex items-center gap-2 mb-3">
          <button class="btn" id="gPrev" type="button">‚Üê</button>
          <div id="gTitle" class="font-medium"></div>
          <button class="btn" id="gNext" type="button">‚Üí</button>
          <span class="text-sm text-slate-600">Click en un d√≠a para ver qui√©nes solicitaron</span>
        </div>
        <div class="calendar" id="gCal"></div>
      </div>

      <!-- Modal general -->
      <div id="gModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center">
        <div class="bg-white rounded-xl p-4 w-[520px] max-w-[95%]">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-medium" id="gModalTitle">Solicitudes</h3>
            <button class="btn" id="gClose" type="button">Cerrar</button>
          </div>
          <div id="gList" class="text-sm"></div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ============== CONFIG SUPABASE ============== */
const SUPABASE_URL = "https://atmcrlvaqmfulmujftrd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0bWNybHZhcW1mdWxtdWpmdHJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNDc5NjgsImV4cCI6MjA3MTgyMzk2OH0.ib1A6TlmEoqgPNnOdRh6ZQ0m_3dYrqAxSxCsr6yNoeM";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============== UTILS ============== */
const $$  = (s, el=document) => el.querySelector(s);
const $$$ = (s, el=document) => Array.from(el.querySelectorAll(s));
function iso(d){ return new Date(d).toISOString().slice(0,10); }
function monthTitle(y,m){ return ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][m]+' '+y; }
function firstCell(y,m){ const f=new Date(y,m,1); const dow=(f.getDay()+6)%7; const s=new Date(f); s.setDate(f.getDate()-dow); return s; }
const L1 = { id:1, name:'Av. Rivadavia 1745' };
const L2 = { id:2, name:'Hip√≥lito Yrigoyen 1236' };

/* ============== STATE ============== */
let sessionUser=null, profile=null;
const cal = {
  1: { y:new Date().getFullYear(), m:new Date().getMonth(), selected:new Set() },
  2: { y:new Date().getFullYear(), m:new Date().getMonth(), selected:new Set() }
};
let gYear = new Date().getFullYear();
let gMonth = new Date().getMonth();

/* ============== INIT ============== */
(async function(){
  // auth buttons
  $$('#signInBtn').addEventListener('click', (e)=>auth(e));
  $$('#showSignup').addEventListener('click', ()=> $$('#signupCard').classList.toggle('hidden'));
  $$('#signUpBtn').addEventListener('click', signUpFull);
  $$('#logoutBtn').addEventListener('click', logout);
  $$('#btnProfile').addEventListener('click', ()=> openTab('profile'));

  // tabs
  $$$('.tab').forEach(b=> b.addEventListener('click',async ()=>{
    const t=b.dataset.tab;
    openTab(t);
    if(t==='worker'){ renderCalendar(1); renderCalendar(2); updateSelResume(); }
    if(t==='myassign') loadMyAssign();
    if(t==='profile')  loadMyProfile();
    if(t==='admin-req') await loadAdminRequests();
    if(t==='admin-assign') {/* usa Ver solicitudes */ }
    if(t==='general') await renderGeneralCalendar();
  }));

  // calendars nav
  $$('#cal1Prev').addEventListener('click', ()=>{ moveMonth(1,-1); });
  $$('#cal1Next').addEventListener('click', ()=>{ moveMonth(1, 1); });
  $$('#cal2Prev').addEventListener('click', ()=>{ moveMonth(2,-1); });
  $$('#cal2Next').addEventListener('click', ()=>{ moveMonth(2, 1); });

  $$('#btnSolicitar').addEventListener('click', solicitarDias);

  // profile
  $$('#btnSaveProfile').addEventListener('click', saveMyProfile);

  // admin assign
  $$('#btnLoadPool').addEventListener('click', loadAdminPool);
  $$('#btnExport').addEventListener('click', exportCSV);

  // admin requests
  $$('#btnRqLoad').addEventListener('click', loadAdminRequests);
  $$('#btnRqExport').addEventListener('click', exportRqCSV);

  // general modal
  $$('#gPrev').addEventListener('click', ()=>{ gMonth--; if(gMonth<0){gMonth=11;gYear--;} renderGeneralCalendar(); });
  $$('#gNext').addEventListener('click', ()=>{ gMonth++; if(gMonth>11){gMonth=0; gYear++;} renderGeneralCalendar(); });
  $$('#gClose').addEventListener('click', ()=>{ $$('#gModal').classList.add('hidden'); $$('#gModal').classList.remove('flex'); });

  // session
  const { data:{ session } } = await supabase.auth.getSession();
  if(session?.user) await onLogin(session.user); else { showAuth(true); }
  supabase.auth.onAuthStateChange(async(_e,s)=>{ if(s?.user) await onLogin(s.user); else onLogout(); });
})();

/* ============== AUTH ============== */
async function auth(e){
  e.preventDefault();
  const email=$$('#email').value.trim(), password=$$('#password').value.trim(), msg=$$('#authMsg');
  if(!email||!password){ msg.textContent='Complet√° email y contrase√±a'; msg.className='text-red-600'; return; }
  try{
    const res = await supabase.auth.signInWithPassword({ email, password });
    if(res.error) throw res.error;
    msg.textContent='Ingreso correcto.'; msg.className='text-emerald-600';
    await onLogin(res.data.user || (await supabase.auth.getUser()).data.user);
  }catch(err){ msg.textContent=err.message; msg.className='text-red-600'; }
}

async function signUpFull(e){
  e.preventDefault();
  const full_name=$$('#su_fullname').value.trim();
  const dni=$$('#su_dni').value.trim();
  const cuil=$$('#su_cuil').value.trim();
  const phone=$$('#su_phone').value.trim();
  const address=$$('#su_address').value.trim();
  const city=$$('#su_city').value.trim();
  const notes=$$('#su_notes').value.trim();
  const email=$$('#su_email').value.trim();
  const password=$$('#su_pass').value.trim();
  const msg=$$('#authMsg');

  if(!full_name||!email||!password){ msg.textContent='Complet√° nombre, email y contrase√±a'; msg.className='text-red-600'; return; }

  try{
    const res = await supabase.auth.signUp({ email, password, options:{ data:{ full_name } }});
    if(res.error) throw res.error;
    const u = res.data.user;
    if(u){
      await supabase.from('profiles').upsert({ id: u.id, full_name, dni, cuil, phone, address, city, notes }, { onConflict:'id' });
      msg.textContent='Cuenta creada.'; msg.className='text-emerald-600';
      await onLogin(u);
    }
  }catch(err){ console.error(err); msg.textContent=err.message; msg.className='text-red-600'; }
}

async function onLogin(u){
  sessionUser = u;
  let { data: prof } = await supabase.from('profiles').select('*').eq('id', u.id).maybeSingle();
  if(!prof){
    await supabase.from('profiles').insert({ id:u.id, full_name: u.user_metadata?.full_name || u.email?.split('@')[0] || 'Usuario' });
    ({ data: prof } = await supabase.from('profiles').select('*').eq('id', u.id).maybeSingle());
  }
  profile = prof||{};

  // UI
  $$('#userBox').classList.remove('hidden');
  $$('#userName').textContent = `${u.email} ‚Äî rol: ${profile.role||'worker'}`;
  showAuth(false);

  // mostrar tabs admin
  const isAdmin = profile?.role==='admin';
  $$('#btnTabAdmin').classList.toggle('hidden', !isAdmin);
  $$('#btnTabReq').classList.toggle('hidden', !isAdmin);
  $$('#btnTabGeneral').classList.toggle('hidden', !isAdmin);

  // selects admin
  const sel=$$('#admLocation'); sel.innerHTML='';
  [L1,L2].forEach(l=>{ const o=document.createElement('option'); o.value=l.id; o.textContent=`${l.id} ‚Äî ${l.name}`; sel.appendChild(o); });
  const rql=$$('#rqLocation'); rql.innerHTML='<option value="">(Todas)</option>';
  [L1,L2].forEach(l=>{ const o=document.createElement('option'); o.value=l.id; o.textContent=`${l.id} ‚Äî ${l.name}`; rql.appendChild(o); });

  $$('#admDay').valueAsDate=new Date();
  const f=new Date(); $$('#rqFrom').valueAsDate=new Date(f.getFullYear(), f.getMonth(), 1); $$('#rqTo').valueAsDate=new Date(f.getFullYear(), f.getMonth()+1, 0);

  // abrir
  openTab(isAdmin ? 'admin-req' : 'worker');
  if(isAdmin) await loadAdminRequests();
  renderCalendar(1); renderCalendar(2); updateSelResume();
}

function onLogout(){ sessionUser=null; profile=null; showAuth(true); }
async function logout(){ await supabase.auth.signOut(); showAuth(true); }

function showAuth(show){
  $$('#auth').classList.toggle('hidden', !show);
  $$('#app').classList.toggle('hidden', show);
}

function openTab(name){
  ['worker','myassign','profile','admin-req','admin-assign','general'].forEach(n=> $$('#tab-'+n)?.classList.toggle('hidden', n!==name));
}

/* ============== CALENDARIOS WORKER ============== */
function moveMonth(calId, delta){
  cal[calId].m += delta;
  if(cal[calId].m<0){ cal[calId].m=11; cal[calId].y--; }
  if(cal[calId].m>11){ cal[calId].m=0;  cal[calId].y++; }
  renderCalendar(calId);
}
function renderCalendar(calId){
  const state = cal[calId];
  const box = $$('#cal'+calId);
  const title = $$('#cal'+calId+'Title');
  title.textContent = monthTitle(state.y, state.m);
  box.innerHTML='';
  ['L','M','M','J','V','S','D'].forEach(h=>{ const d=document.createElement('div'); d.className='cal-head'; d.textContent=h; box.appendChild(d); });

  const start = firstCell(state.y, state.m);
  for(let i=0;i<42;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const key=iso(d);
    const inMonth=(d.getMonth()===state.m);
    const div=document.createElement('div');
    div.className='cal-cell'+(inMonth?' clickable':' disabled');
    if(state.selected.has(key)) div.classList.add('selected');
    div.innerHTML=`<div class="d">${d.getDate()}</div>`;
    if(inMonth){
      div.addEventListener('click', ()=>{
        if(state.selected.has(key)) state.selected.delete(key); else state.selected.add(key);
        div.classList.toggle('selected');
        updateSelResume();
      });
    }
    box.appendChild(div);
  }
}
function updateSelResume(){
  const c1=[...cal[1].selected].length, c2=[...cal[2].selected].length;
  $$('#selResume').textContent = `Rivadavia: ${c1} d√≠a(s) ‚Äî Yrigoyen: ${c2} d√≠a(s)`;
}

/* ============== SOLICITUD (carga + PDF PLANILLA) ============== */
async function solicitarDias(){
  if(!sessionUser) return;

  // 1) Recolecto selecci√≥n de ambos calendarios
  const sel1=[...cal[1].selected].sort();        // Rivadavia
  const sel2=[...cal[2].selected].sort();        // Yrigoyen
  const sh1 = (document.querySelector('input[name="sh1"]:checked')?.value)||'07-19';
  const sh2 = (document.querySelector('input[name="sh2"]:checked')?.value)||'07-19';

  if(sel1.length===0 && sel2.length===0){
    alert('No seleccionaste d√≠as.');
    return;
  }

  // 2) Inserto en availabilities (idempotente por UNIQUE)
  for(const d of sel1){
    await supabase.from('availabilities').insert({ user_id:sessionUser.id, location_id:1, shift_label:sh1, day:d }).then(()=>{});
  }
  for(const d of sel2){
    await supabase.from('availabilities').insert({ user_id:sessionUser.id, location_id:2, shift_label:sh2, day:d }).then(()=>{});
  }

  // 3) Tomo el perfil fresco desde la DB
  const { data: fresh } = await supabase.from('profiles').select('*').eq('id', sessionUser.id).maybeSingle();
  profile = fresh || profile || {};

  // 4) Genero PDF con exactamente los d√≠as seleccionados
  genPDFSolicitud({
    profile,
    bloques: [
      { sede:'Av. Rivadavia 1745', turno:sh1, dias:sel1 },
      { sede:'Hip√≥lito Yrigoyen 1236', turno:sh2, dias:sel2 }
    ]
  });

  // 5) Limpio selecci√≥n visual
  cal[1].selected.clear(); cal[2].selected.clear();
  renderCalendar(1); renderCalendar(2); updateSelResume();

  alert('Solicitud registrada. Se gener√≥ la planilla en PDF.');
}

/* ======= Helpers PDF ======= */
function headerPDF(doc, title){
  doc.setFont('helvetica','bold'); doc.setFontSize(13);
  doc.text(title, 14, 16);
  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text('SECCI√ìN SEGURIDAD Y CUSTODIA - AUDITOR√çA GENERAL DE LA NACI√ìN', 14, 22);
  doc.line(14, 25, 196, 25);
}
function kv(doc, k, v, x, y){
  doc.setFont('helvetica','bold'); doc.text(k+':', x, y);
  doc.setFont('helvetica','normal'); doc.text(String(v ?? '-'), x+36, y);
}

/* ======= PDF SOLICITUD (exacto a lo seleccionado) ======= */
function genPDFSolicitud({ profile, bloques }){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Determinar mes/a√±o seg√∫n el primer d√≠a seleccionado (si no hay, hoy)
  const allDays = [...(bloques[0]?.dias||[]), ...(bloques[1]?.dias||[])].sort();
  const base = allDays.length ? new Date(allDays[0]) : new Date();
  const m = base.getMonth(), y = base.getFullYear();
  const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const labelMes = `${meses[m]} ${y}`;

  // √çndice por n√∫mero de d√≠a del MES BASE
  const dayNum = (isoStr)=>{ const d=new Date(isoStr); return (d.getMonth()===m && d.getFullYear()===y) ? d.getDate() : null; };
  const tabla = {}; // { 1: { '07-19': ['X1','X2'], '19-07': [] }, ... }
  const sedeTag = (s)=> /rivadavia/i.test(s) ? 'X1' : /yrigoyen|yirgoyen/i.test(s) ? 'X2' : 'X';

  bloques.forEach(b=>{
    const tag = sedeTag(b.sede);
    (b.dias||[]).forEach(d=>{
      const n = dayNum(d);
      if(n){
        tabla[n] = tabla[n] || { '07-19':[], '19-07':[] };
        if(!tabla[n][b.turno].includes(tag)) tabla[n][b.turno].push(tag);
      }
    });
  });

  headerPDF(doc, 'SOLICITUD DE SERVICIOS BAJO EL R√âGIMEN DE POLIC√çA ADICIONAL');

  // Datos personales
  let y0 = 32;
  kv(doc,'NOMBRE Y APELLIDO', profile.full_name, 14, y0); y0+=6;
  doc.setFont('helvetica','bold'); doc.text('D.N.I.:',14,y0);
  doc.setFont('helvetica','normal'); doc.text(String(profile.dni||'-'), 35, y0);
  doc.setFont('helvetica','bold'); doc.text('   C.U.I.L.:', 80, y0);
  doc.setFont('helvetica','normal'); doc.text(String(profile.cuil||'-'), 112, y0);
  doc.setFont('helvetica','bold'); doc.text('   L.P.:', 150, y0);
  doc.setFont('helvetica','normal'); doc.text(String(profile.lp||'-'), 165, y0);
  y0+=6;

  kv(doc,'C√ìDIGO DE DEPENDENCIA', profile.dep_code, 14, y0); y0+=6;
  kv(doc,'JERARQU√çA', profile.jerarquia, 14, y0); y0+=6;
  kv(doc,'TEL√âFONO', profile.phone, 14, y0); y0+=6;
  kv(doc,'DOMICILIO', `${profile.address||'-'} ‚Äî ${profile.city||''}`, 14, y0); y0+=6;
  kv(doc,'HORARIO ORDINARIO', profile.horario_ordinario || '07.00 a 19.00', 14, y0); y0+=8;

  // Cabecera y mes
  doc.setFont('helvetica','bold'); doc.text('MES:', 14, y0);
  doc.setFont('helvetica','normal'); doc.text(labelMes, 26, y0); y0+=6;

  // Tabla de d√≠as del mes base
  const startY = y0+2;
  const xDia=14, x07=35, x19=70, xObs=105, rowH=6;

  // Header de tabla
  doc.rect(xDia-2, startY-5, 180, 7);
  doc.text('D√≠a', xDia, startY);
  doc.text('07 a 19', x07, startY);
  doc.text('19 a 07', x19, startY);
  doc.text('Observaciones', xObs, startY);

  let yRow = startY + 6;
  // Cantidad de d√≠as del mes base
  const lastDay = new Date(y, m+1, 0).getDate();

  for(let d=1; d<=lastDay; d++){
    const info = tabla[d] || { '07-19':[], '19-07':[] };
    const m07 = info['07-19'];
    const m19 = info['19-07'];

    doc.rect(xDia-2, yRow-5, 180, 6);
    doc.text(String(d), xDia, yRow);
    if(m07.length) doc.text('X', x07, yRow);
    if(m19.length) doc.text('X', x19, yRow);
    const obs = [...new Set([...m07, ...m19])].join(' + ');
    if(obs) doc.text(obs, xObs, yRow);

    yRow += rowH;
    if (yRow > 270){ doc.addPage(); yRow = 20; }
  }

  // Totales y firma
  const totalSeleccionados = Object.values(tabla).reduce((acc, v)=> acc + ((v['07-19'].length || v['19-07'].length) ? 1 : 0), 0);
  yRow += 6;
  doc.setFont('helvetica','bold'); doc.text(`CANTIDAD DE D√çAS REQUERIDOS: ${totalSeleccionados}`, 14, yRow); yRow+=10;
  doc.setFont('helvetica','normal'); doc.text(`FECHA: ${new Date().toLocaleDateString('es-AR')}`, 14, yRow); yRow+=10;
  doc.text('FIRMA: ____________________________    ACLARACI√ìN: ____________________________', 14, yRow);

  const fname = `SOLICITUD_SERVICIOS_${(profile.full_name||'usuario').replace(/\s+/g,'_')}_${labelMes.replace(/\s+/g,'_')}.pdf`;
  doc.save(fname);
}

/* ============== MIS ASIGNACIONES ============== */
async function loadMyAssign(){
  const { data } = await supabase.from('assignments').select('day, shift_label, status, locations(name,id)').eq('user_id', sessionUser.id).order('day');
  const tb=$$('#myAssign'); tb.innerHTML='';
  (data||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="py-2">${r.day}</td><td>${r.locations?.id} ‚Äî ${r.locations?.name||''}</td><td>${r.shift_label}</td><td><span class="chip">${r.status}</span></td>`;
    tb.appendChild(tr);
  });
}

/* ============== MIS DATOS (perfil) ============== */
async function loadMyProfile(){
  const { data } = await supabase.from('profiles').select('*').eq('id', sessionUser.id).maybeSingle();
  const p = data||{};
  $$('#pf_full_name').value = p.full_name||'';
  $$('#pf_dni').value       = p.dni||'';
  $$('#pf_lp').value        = p.lp||'';
  $$('#pf_dep_code').value  = p.dep_code||'';
  $$('#pf_jerarquia').value = p.jerarquia||'';
  $$('#pf_horario').value   = p.horario_ordinario||'';
  $$('#pf_phone').value     = p.phone||'';
  $$('#pf_address').value   = p.address||'';
  $$('#pf_city').value      = p.city||'';
  $$('#pf_notes').value     = p.notes||'';
}
async function saveMyProfile(){
  const row = {
    id: sessionUser.id,
    full_name: $$('#pf_full_name').value.trim()||null,
    dni: $$('#pf_dni').value.trim()||null,
    lp: $$('#pf_lp').value.trim()||null,
    dep_code: $$('#pf_dep_code').value.trim()||null,
    jerarquia: $$('#pf_jerarquia').value.trim()||null,
    horario_ordinario: $$('#pf_horario').value.trim()||null,
    phone: $$('#pf_phone').value.trim()||null,
    address: $$('#pf_address').value.trim()||null,
    city: $$('#pf_city').value.trim()||null,
    notes: $$('#pf_notes').value.trim()||null
  };
  await supabase.from('profiles').upsert(row, { onConflict:'id' });
  alert('Datos guardados.');
}

/* ============== ADMIN: SOLICITUDES (nuevo panel) ============== */
async function loadAdminRequests(){
  const from=$$('#rqFrom').value, to=$$('#rqTo').value, loc=$$('#rqLocation').value, sh=$$('#rqShift').value, q=$$('#rqSearch').value?.toLowerCase()||'';
  let req = supabase.from('availabilities').select('day, shift_label, location_id, profiles(full_name)');
  if(from) req=req.gte('day', from);
  if(to)   req=req.lte('day', to);
  if(loc)  req=req.eq('location_id', parseInt(loc));
  if(sh)   req=req.eq('shift_label', sh);
  const { data } = await req.order('day');

  const rows = (data||[]).filter(r=> (r.profiles?.full_name||'').toLowerCase().includes(q) );
  $$('#rqResume').textContent = `${rows.length} solicitud(es)`;
  const tb=$$('#rqTable'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const sede = r.location_id===1? 'Rivadavia' : r.location_id===2? 'Yrigoyen' : ('Loc '+r.location_id);
    tr.innerHTML=`<td class="py-2">${r.day}</td><td>${r.profiles?.full_name||''}</td><td>${sede}</td><td>${r.shift_label}</td>`;
    tb.appendChild(tr);
  });
}
async function exportRqCSV(){
  const from=$$('#rqFrom').value, to=$$('#rqTo').value, loc=$$('#rqLocation').value, sh=$$('#rqShift').value, q=$$('#rqSearch').value?.toLowerCase()||'';
  let req = supabase.from('availabilities').select('day, shift_label, location_id, profiles(full_name)');
  if(from) req=req.gte('day', from);
  if(to)   req=req.lte('day', to);
  if(loc)  req=req.eq('location_id', parseInt(loc));
  if(sh)   req=req.eq('shift_label', sh);
  const { data } = await req.order('day');
  const rows = (data||[]).filter(r=> (r.profiles?.full_name||'').toLowerCase().includes(q) );
  const csvRows = [['Fecha','Nombre','Ubicaci√≥n','Turno']].concat(rows.map(r=>[
    r.day, r.profiles?.full_name||'', r.location_id===1?'Rivadavia':'Yrigoyen', r.shift_label
  ]));
  const csv = csvRows.map(r=>r.map(x=>`"${String(x||'').replaceAll('"','""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`solicitudes_${from||''}_${to||''}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* ============== ADMIN: ASIGNACIONES ============== */
async function loadAdminPool(){
  const day=$$('#admDay').value; const location_id=parseInt($$('#admLocation').value); const shift_label=$$('#admShift').value;
  if(!day||!location_id||!shift_label) return alert('Complet√° filtros');

  const { data: cap } = await supabase.from('vacancy_status').select('*').eq('day', day).eq('location_id', location_id).eq('shift_label', shift_label).maybeSingle();
  $$('#capacityBox').innerHTML = cap? `<div class="chip">Cupos: ${cap.cupos} ‚Äî Ocupados: ${cap.ocupados} ‚Äî Disponibles: ${cap.disponibles}</div>` : '<div class="chip">Sin regla cargada</div>';

  const { data: pool } = await supabase.from('availabilities').select('user_id, profiles(full_name,email)').eq('day',day).eq('location_id',location_id).eq('shift_label',shift_label).order('created_at');
  const body=$$('#pool'); body.innerHTML='';
  (pool||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="py-2">${r.profiles?.full_name||'(Sin nombre)'}<div class="text-slate-500 text-xs">${r.profiles?.email||''}</div></td>
    <td><button class="btn" data-add="${r.user_id}">Asignar</button></td>`;
    body.appendChild(tr);
  });

  const { data: assigned } = await supabase.from('assignments').select('id,user_id,status,profiles(full_name,email)').eq('day',day).eq('location_id',location_id).eq('shift_label',shift_label).order('created_at');
  const as=$$('#assigned'); as.innerHTML='';
  (assigned||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="py-2">${r.profiles?.full_name||'(Sin nombre)'}<div class="text-slate-500 text-xs">${r.profiles?.email||''}</div></td>
    <td><span class="chip">${r.status}</span></td>
    <td class="space-x-2">
      <button class="text-emerald-700" data-confirm="${r.id}">Confirmar</button>
      <button class="text-red-700" data-del="${r.id}">Quitar</button>
    </td>`;
    as.appendChild(tr);
  });

  $$$('#pool [data-add]').forEach(b=> b.addEventListener('click', ()=> addAssignment(b.dataset.add, day, location_id, shift_label)));
  $$$('#assigned [data-confirm]').forEach(b=> b.addEventListener('click', async()=>{ await updateAssignmentStatus(parseInt(b.dataset.confirm), 'confirmado'); loadAdminPool(); }));
  $$$('#assigned [data-del]').forEach(b=> b.addEventListener('click', async()=>{ await deleteAssignment(parseInt(b.dataset.del)); loadAdminPool(); }));
}
async function addAssignment(user_id, day, location_id, shift_label){
  const { data: cap } = await supabase.from('vacancy_status').select('*').eq('day',day).eq('location_id',location_id).eq('shift_label',shift_label).maybeSingle();
  if(cap && cap.disponibles<=0) return alert('No hay cupos disponibles.');
  await supabase.from('assignments').insert({ user_id, day, location_id, shift_label, status:'propuesto', created_by: sessionUser.id });
  await loadAdminPool();
}
function updateAssignmentStatus(id,status){ return supabase.from('assignments').update({ status }).eq('id', id); }
function deleteAssignment(id){ return supabase.from('assignments').delete().eq('id', id); }
async function exportCSV(){
  const day=$$('#admDay').value; const location_id=parseInt($$('#admLocation').value); const shift_label=$$('#admShift').value;
  const { data } = await supabase.from('assignments').select('day,shift_label,status,profiles(full_name,email),locations(name)').eq('day',day).eq('location_id',location_id).eq('shift_label',shift_label);
  const rows=[['Fecha','Ubicaci√≥n','Turno','Nombre','Email','Estado']].concat((data||[]).map(r=>[r.day,r.locations?.name||'',r.shift_label,r.profiles?.full_name||'',r.profiles?.email||'',r.status]));
  const csv = rows.map(r=>r.map(x=>`"${String(x||'').replaceAll('"','""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`asignaciones_${day}_${location_id}_${shift_label}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* ============== CALENDARIO GENERAL (ADMIN) ============== */
async function renderGeneralCalendar(){
  const title = monthTitle(gYear, gMonth);
  $$('#gTitle').textContent = title;

  const box = $$('#gCal'); box.innerHTML='';
  ['L','M','M','J','V','S','D'].forEach(h=>{ const d=document.createElement('div'); d.className='cal-head'; d.textContent=h; box.appendChild(d); });

  const from = new Date(gYear, gMonth, 1);
  const to   = new Date(gYear, gMonth+1, 0);
  const { data } = await supabase.from('availabilities').select('day, shift_label, location_id, profiles(full_name)').gte('day', iso(from)).lte('day', iso(to));

  const byDay = {};
  (data||[]).forEach(r=>{
    byDay[r.day] = byDay[r.day] || [];
    byDay[r.day].push({ name:r.profiles?.full_name||'(sin nombre)', location_id:r.location_id, shift_label:r.shift_label });
  });

  const start = firstCell(gYear, gMonth);
  for(let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const key = iso(d);
    const inMonth = d.getMonth()===gMonth;
    const lst = byDay[key] || [];
    const count = lst.length;

    const div=document.createElement('div');
    div.className='cal-cell'+(inMonth?' clickable':' disabled');
    div.innerHTML = `<div class="d">${d.getDate()}</div><div>${count? `<span class="chip">${count} solicitud(es)</span>`:''}</div>`;
    if(inMonth){
      div.addEventListener('click', ()=>{
        $$('#gModal').classList.remove('hidden'); $$('#gModal').classList.add('flex');
        $$('#gModalTitle').textContent = `Solicitudes ‚Äî ${key}`;
        if(!count){ $$('#gList').innerHTML = '<div class="text-slate-500">Sin solicitudes.</div>'; return; }
        const rows = lst.map(x=>{
          const sede = x.location_id===1 ? 'Rivadavia (X1)' : x.location_id===2 ? 'Yrigoyen (X2)' : `Loc ${x.location_id}`;
          return `<div class="py-1 border-b last:border-0">${x.name} ‚Äî ${sede} ‚Äî ${x.shift_label}</div>`;
        }).join('');
        $$('#gList').innerHTML = rows;
      });
    }
    box.appendChild(div);
  }
}
</script>
</body>
</html>
