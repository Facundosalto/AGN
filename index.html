<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM Vacantes ‚Äî Supabase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{color-scheme:light}
    body{
      background:
        radial-gradient(1000px 700px at -10% -20%, #dbeafe 0, transparent 60%),
        radial-gradient(1200px 700px at 110% 0%, #e0e7ff 0, transparent 60%),
        #f6f9fc;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    .hero {
      background: linear-gradient(180deg,#2563eb,#1e3a8a);
      border-radius: 18px;
      color: #fff;
      padding: 24px;
      box-shadow: 0 14px 30px rgba(2,6,23,.15);
    }
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 14px 30px rgba(2,6,23,.08)}
    .input{width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:12px;background:#fff}
    .btn{padding:12px 14px;border:1px solid #cbd5e1;border-radius:12px;background:linear-gradient(#ffffff,#eef2ff);box-shadow:0 6px 0 #c7d2fe;transform:translateY(0);transition:.15s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 7px 0 #c7d2fe}
    .btn:active{transform:translateY(1px);box-shadow:0 4px 0 #c7d2fe}
    .btn-primary{padding:12px 14px;border-radius:12px;background:linear-gradient(180deg,#1e40af,#0f172a);color:#fff;box-shadow:0 6px 0 #0b1223;border:1px solid #0b1223}
    .chip{display:inline-block;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#f8fafc;font-size:12px}
    .secure {background:linear-gradient(90deg,#e0f2fe,#e0e7ff);border:1px solid #bfdbfe}
    .calendar{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:6px}
    .cal-head,.cal-cell{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;min-height:62px}
    .cal-head{font-weight:600;text-align:center;background:#f8fafc}
    .cal-cell .d{font-weight:600}
    .cal-cell.disabled{opacity:.35;pointer-events:none}
    .cal-cell.clickable{cursor:pointer;outline:2px solid transparent}
    .cal-cell.clickable:hover{outline-color:#2563eb}
    .cal-cell.selected{outline:2px solid #1e40af;background:#eef2ff}
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <div class="hero mb-6">
      <h1 class="text-3xl font-bold">CRM Vacantes ‚Äî Supabase</h1>
      <p class="opacity-90">Gesti√≥n de disponibilidad y asignaciones de personal</p>
    </div>

    <div class="flex items-center justify-between mb-4">
      <div class="text-sm secure px-3 py-1 rounded-lg">üîí Tus datos est√°n seguros (Auth + RLS)</div>
      <div id="userBox" class="hidden items-center gap-3">
        <span id="userName" class="chip"></span>
        <button id="logoutBtn" class="btn">Salir</button>
      </div>
    </div>

    <!-- AUTH -->
    <section id="auth" class="card p-6">
      <h2 class="text-xl font-semibold mb-2">Ingresar</h2>
      <p class="text-slate-600 mb-4">Cre√° tu usuario o inici√° sesi√≥n con email y contrase√±a.</p>
      <form class="grid md:grid-cols-2 gap-3">
        <input id="email" type="email" placeholder="Email" class="input" required />
        <input id="password" type="password" placeholder="Contrase√±a" class="input" required />
        <button id="signInBtn" class="btn-primary"><span class="inline-block mr-1">üîê</span>Ingresar</button>
        <button id="showSignup" type="button" class="btn">Crear cuenta</button>
      </form>
      <p id="authMsg" class="mt-3 text-sm"></p>

      <!-- REGISTRO AMPLIADO -->
      <div id="signupCard" class="hidden mt-6 border-t pt-6">
        <h3 class="font-semibold mb-2">Datos del postulante</h3>
        <div class="grid md:grid-cols-3 gap-3">
          <input id="su_fullname" class="input" placeholder="Nombre y apellido" />
          <input id="su_dni" class="input" placeholder="DNI" />
          <input id="su_cuil" class="input" placeholder="CUIL" />
          <input id="su_phone" class="input" placeholder="Tel√©fono" />
          <input id="su_address" class="input" placeholder="Direcci√≥n" />
          <input id="su_city" class="input" placeholder="Ciudad" />
          <input id="su_email" class="input md:col-span-2" placeholder="Email (para crear usuario)" />
          <input id="su_pass" type="password" class="input" placeholder="Contrase√±a" />
          <textarea id="su_notes" class="input md:col-span-3" rows="2" placeholder="Notas (opcional)"></textarea>
        </div>
        <div class="mt-3">
          <button id="signUpBtn" class="btn-primary">Crear cuenta</button>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="hidden">
      <nav class="flex flex-wrap gap-2 mb-4">
        <button data-tab="worker"    class="tab btn">Solicitar d√≠as</button>
        <button data-tab="myassign"  class="tab btn">Mis asignaciones</button>
        <button data-tab="admin"     class="tab btn hidden" id="btnTabAdmin">Panel Admin</button>
      </nav>

      <!-- WORKER: DOS CALENDARIOS -->
      <div id="tab-worker" class="card p-6 hidden">
        <h2 class="text-lg font-semibold mb-2">Seleccion√° d√≠as y turnos</h2>
        <p class="text-slate-600 mb-3">Tild√° los d√≠as en cada sede. Eleg√≠ turno y luego ‚ÄúSolicitar d√≠as‚Äù.</p>

        <div class="grid lg:grid-cols-2 gap-6">
          <!-- Rivadavia -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-medium">Av. Rivadavia 1745</h3>
              <div class="flex items-center gap-2">
                <label class="chip"><input type="radio" name="sh1" value="07-19" class="mr-1" checked/>07‚Äì19</label>
                <label class="chip"><input type="radio" name="sh1" value="19-07" class="mr-1"/>19‚Äì07</label>
              </div>
            </div>
            <div class="flex items-center gap-2 mb-2">
              <button class="btn" id="cal1Prev">‚Üê</button>
              <div id="cal1Title" class="font-medium"></div>
              <button class="btn" id="cal1Next">‚Üí</button>
            </div>
            <div id="cal1" class="calendar"></div>
          </div>

          <!-- Yrigoyen -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-medium">Hip√≥lito Yrigoyen 1236</h3>
              <div class="flex items-center gap-2">
                <label class="chip"><input type="radio" name="sh2" value="07-19" class="mr-1" checked/>07‚Äì19</label>
                <label class="chip"><input type="radio" name="sh2" value="19-07" class="mr-1"/>19‚Äì07</label>
              </div>
            </div>
            <div class="flex items-center gap-2 mb-2">
              <button class="btn" id="cal2Prev">‚Üê</button>
              <div id="cal2Title" class="font-medium"></div>
              <button class="btn" id="cal2Next">‚Üí</button>
            </div>
            <div id="cal2" class="calendar"></div>
          </div>
        </div>

        <div class="mt-4 flex items-center gap-3">
          <button id="btnSolicitar" class="btn-primary">Solicitar d√≠as</button>
          <span class="text-sm text-slate-600" id="selResume">‚Äî</span>
        </div>
      </div>

      <!-- MIS ASIGNACIONES -->
      <div id="tab-myassign" class="card p-6 hidden">
        <h2 class="text-lg font-semibold mb-4">Mis asignaciones</h2>
        <table class="w-full text-sm">
          <thead><tr class="text-left"><th class="py-2">Fecha</th><th>Ubicaci√≥n</th><th>Turno</th><th>Estado</th></tr></thead>
          <tbody id="myAssign"></tbody>
        </table>
      </div>

      <!-- ADMIN -->
      <div id="tab-admin" class="card p-6 hidden">
        <h2 class="text-lg font-semibold mb-4">Panel de administraci√≥n</h2>
        <div class="grid md:grid-cols-5 gap-3 mb-4">
          <input id="admDay" type="date" class="input" />
          <select id="admLocation" class="input"></select>
          <select id="admShift" class="input">
            <option value="07-19">07‚Äì19</option>
            <option value="19-07">19‚Äì07</option>
          </select>
          <button id="btnLoadPool" class="btn">Ver solicitudes</button>
          <button id="btnExport" class="btn">Exportar CSV (d√≠a)</button>
        </div>

        <div id="capacityBox" class="mb-4"></div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-medium mb-2">Candidatos</h3>
            <table class="w-full text-sm">
              <thead><tr class="text-left"><th class="py-2">Persona</th><th></th></tr></thead>
              <tbody id="pool"></tbody>
            </table>
          </div>
          <div>
            <h3 class="font-medium mb-2">Asignados</h3>
            <table class="w-full text-sm">
              <thead><tr class="text-left"><th class="py-2">Persona</th><th>Estado</th><th></th></tr></thead>
              <tbody id="assigned"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ============== CONFIG SUPABASE ============== */
const SUPABASE_URL = "https://atmcrlvaqmfulmujftrd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0bWNybHZhcW1mdWxtdWpmdHJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNDc5NjgsImV4cCI6MjA3MTgyMzk2OH0.ib1A6TlmEoqgPNnOdRh6ZQ0m_3dYrqAxSxCsr6yNoeM";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============== UTILS ============== */
const $$  = (s, el=document) => el.querySelector(s);
const $$$ = (s, el=document) => Array.from(el.querySelectorAll(s));
function iso(d){ return new Date(d).toISOString().slice(0,10); }
function monthTitle(y,m){ return ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][m]+' '+y; }
function firstCell(y,m){ const f=new Date(y,m,1); const dow=(f.getDay()+6)%7; const s=new Date(f); s.setDate(f.getDate()-dow); return s; }
const L1 = { id:1, name:'Av. Rivadavia 1745' };
const L2 = { id:2, name:'Hip√≥lito Yrigoyen 1236' };

/* ============== STATE ============== */
let sessionUser=null, profile=null;
const cal = {
  // cada calendario tiene a√±o/mes y un set de fechas seleccionadas
  1: { y:new Date().getFullYear(), m:new Date().getMonth(), selected:new Set() },
  2: { y:new Date().getFullYear(), m:new Date().getMonth(), selected:new Set() }
};

/* ============== INIT ============== */
(async function(){
  // auth buttons
  $$('#signInBtn').addEventListener('click', (e)=>auth(e,false));
  $$('#showSignup').addEventListener('click', ()=> $$('#signupCard').classList.toggle('hidden'));
  $$('#signUpBtn').addEventListener('click', signUpFull);
  $$('#logoutBtn').addEventListener('click', logout);

  // tabs
  $$$('.tab').forEach(b=> b.addEventListener('click',()=> {
    const t=b.dataset.tab; ['worker','myassign','admin'].forEach(n=> $$('#tab-'+n)?.classList.toggle('hidden', n!==t));
    if(t==='worker'){ renderCalendar(1); renderCalendar(2); updateSelResume(); }
    if(t==='myassign') loadMyAssign();
  }));

  // calendars nav
  $$('#cal1Prev').addEventListener('click', ()=>{ moveMonth(1,-1); });
  $$('#cal1Next').addEventListener('click', ()=>{ moveMonth(1, 1); });
  $$('#cal2Prev').addEventListener('click', ()=>{ moveMonth(2,-1); });
  $$('#cal2Next').addEventListener('click', ()=>{ moveMonth(2, 1); });

  $$('#btnSolicitar').addEventListener('click', solicitarDias);

  // admin
  $$('#btnLoadPool').addEventListener('click', loadAdminPool);
  $$('#btnExport').addEventListener('click', exportCSV);

  // session
  const { data:{ session } } = await supabase.auth.getSession();
  if(session?.user) await onLogin(session.user); else { showAuth(true); }
  supabase.auth.onAuthStateChange(async(_e,s)=>{ if(s?.user) await onLogin(s.user); else onLogout(); });
})();

/* ============== AUTH ============== */
async function auth(e, signup=false){
  e.preventDefault();
  const email=$$('#email').value.trim(), password=$$('#password').value.trim(), msg=$$('#authMsg');
  if(!email||!password){ msg.textContent='Complet√° email y contrase√±a'; msg.className='text-red-600'; return; }
  try{
    const res = await supabase.auth.signInWithPassword({ email, password });
    if(res.error) throw res.error;
    msg.textContent='Ingreso correcto.'; msg.className='text-emerald-600';
    await onLogin(res.data.user || (await supabase.auth.getUser()).data.user);
  }catch(err){ msg.textContent=err.message; msg.className='text-red-600'; }
}

async function signUpFull(e){
  e.preventDefault();
  const full_name=$$('#su_fullname').value.trim();
  const dni=$$('#su_dni').value.trim();
  const cuil=$$('#su_cuil').value.trim();
  const phone=$$('#su_phone').value.trim();
  const address=$$('#su_address').value.trim();
  const city=$$('#su_city').value.trim();
  const notes=$$('#su_notes').value.trim();
  const email=$$('#su_email').value.trim();
  const password=$$('#su_pass').value.trim();
  const msg=$$('#authMsg');

  if(!full_name||!email||!password){ msg.textContent='Complet√° nombre, email y contrase√±a'; msg.className='text-red-600'; return; }

  try{
    const res = await supabase.auth.signUp({ email, password, options:{ data:{ full_name } }});
    if(res.error) throw res.error;
    const u = res.data.user;
    if(u){
      // guardar extra en profiles (RLS: auth.uid()=id)
      await supabase.from('profiles').upsert({
        id: u.id, full_name, dni, cuil, phone, address, city, notes
      }, { onConflict:'id' });
      msg.textContent='Cuenta creada.'; msg.className='text-emerald-600';
      await onLogin(u);
    }
  }catch(err){ console.error(err); msg.textContent=err.message; msg.className='text-red-600'; }
}

async function onLogin(u){
  sessionUser = u;
  let { data: prof } = await supabase.from('profiles').select('*').eq('id', u.id).maybeSingle();
  if(!prof){
    await supabase.from('profiles').insert({ id:u.id, full_name: u.user_metadata?.full_name || u.email?.split('@')[0] || 'Usuario' });
    ({ data: prof } = await supabase.from('profiles').select('*').eq('id', u.id).maybeSingle());
  }
  profile = prof||{};

  // UI
  $$('#userBox').classList.remove('hidden');
  $$('#userName').textContent = `${u.email} ‚Äî rol: ${profile.role||'worker'}`;
  showAuth(false);

  // admin tabs
  const isAdmin = profile?.role==='admin';
  $$('#btnTabAdmin').classList.toggle('hidden', !isAdmin);

  // cargar selects admin (ubicaciones)
  const sel=$$('#admLocation'); sel.innerHTML='';
  [L1,L2].forEach(l=>{ const o=document.createElement('option'); o.value=l.id; o.textContent=`${l.id} ‚Äî ${l.name}`; sel.appendChild(o); });
  const t=new Date(); $$('#admDay').valueAsDate=t;

  // por defecto abrir worker
  ['worker','myassign','admin'].forEach(n=> $$('#tab-'+n)?.classList.add('hidden'));
  $$('#tab-worker')?.classList.remove('hidden');
  renderCalendar(1); renderCalendar(2); updateSelResume();
}

function onLogout(){ sessionUser=null; profile=null; showAuth(true); }
async function logout(){ await supabase.auth.signOut(); }

function showAuth(show){
  $$('#auth').classList.toggle('hidden', !show);
  $$('#app').classList.toggle('hidden', show);
}

/* ============== CALENDARIOS ============== */
function moveMonth(calId, delta){
  cal[calId].m += delta;
  if(cal[calId].m<0){ cal[calId].m=11; cal[calId].y--; }
  if(cal[calId].m>11){ cal[calId].m=0;  cal[calId].y++; }
  renderCalendar(calId);
}

function renderCalendar(calId){
  const state = cal[calId];
  const box = $$('#cal'+calId);
  const title = $$('#cal'+calId+'Title');
  title.textContent = monthTitle(state.y, state.m);
  box.innerHTML='';
  ['L','M','M','J','V','S','D'].forEach(h=>{ const d=document.createElement('div'); d.className='cal-head'; d.textContent=h; box.appendChild(d); });

  const start = firstCell(state.y, state.m);
  for(let i=0;i<42;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const key=iso(d);
    const inMonth=(d.getMonth()===state.m);
    const div=document.createElement('div');
    div.className='cal-cell'+(inMonth?' clickable':' disabled');
    if(state.selected.has(key)) div.classList.add('selected');
    div.innerHTML=`<div class="d">${d.getDate()}</div>`;
    if(inMonth){
      div.addEventListener('click', ()=>{
        if(state.selected.has(key)) state.selected.delete(key); else state.selected.add(key);
        div.classList.toggle('selected');
        updateSelResume();
      });
    }
    box.appendChild(div);
  }
}

function updateSelResume(){
  const c1=[...cal[1].selected].length, c2=[...cal[2].selected].length;
  $$('#selResume').textContent = `Rivadavia: ${c1} d√≠a(s) ‚Äî Yrigoyen: ${c2} d√≠a(s)`;
}

/* ============== SOLICITUD (carga + PDF) ============== */
async function solicitarDias(){
  if(!sessionUser) return;
  const sel1=[...cal[1].selected].sort();
  const sel2=[...cal[2].selected].sort();
  const sh1 = (document.querySelector('input[name="sh1"]:checked')?.value)||'07-19';
  const sh2 = (document.querySelector('input[name="sh2"]:checked')?.value)||'07-19';

  // insertar disponibilidades
  for(const d of sel1){ await supabase.from('availabilities').insert({ user_id:sessionUser.id, location_id:L1.id, shift_label:sh1, day:d }).then(()=>{}); }
  for(const d of sel2){ await supabase.from('availabilities').insert({ user_id:sessionUser.id, location_id:L2.id, shift_label:sh2, day:d }).then(()=>{}); }

  // PDF Solicitud
  genPDFSolicitud({
    profile,
    bloques: [
      { sede:L1.name, turno:sh1, dias:sel1 },
      { sede:L2.name, turno:sh2, dias:sel2 }
    ]
  });

  // limpiar selecci√≥n
  cal[1].selected.clear(); cal[2].selected.clear(); renderCalendar(1); renderCalendar(2); updateSelResume();
}

/* ============== MIS ASIGNACIONES ============== */
async function loadMyAssign(){
  const { data } = await supabase.from('assignments').select('day, shift_label, status, locations(name,id)').eq('user_id', sessionUser.id).order('day');
  const tb=$$('#myAssign'); tb.innerHTML='';
  (data||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="py-2">${r.day}</td><td>${r.locations?.id} ‚Äî ${r.locations?.name||''}</td><td>${r.shift_label}</td><td><span class="chip">${r.status}</span></td>`;
    tb.appendChild(tr);
  });
}

/* ============== ADMIN ============== */
async function loadAdminPool(){
  const day=$$('#admDay').value; const location_id=parseInt($$('#admLocation').value); const shift_label=$$('#admShift').value;
  if(!day||!location_id||!shift_label) return alert('Complet√° filtros');

  // capacidad
  const { data: cap } = await supabase.from('vacancy_status').select('*').eq('day', day).eq('location_id', location_id).eq('shift_label', shift_label).maybeSingle();
  $$('#capacityBox').innerHTML = cap? `<div class="chip">Cupos: ${cap.cupos} ‚Äî Ocupados: ${cap.ocupados} ‚Äî Disponibles: ${cap.disponibles}</div>` : '<div class="chip">Sin regla cargada</div>';

  // pool
  const { data: pool } = await supabase.from('availabilities').select('user_id, profiles(full_name,email)').eq('day',day).eq('location_id',location_id).eq('shift_label',shift_label).order('created_at');
  const body=$$('#pool'); body.innerHTML='';
  (pool||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="py-2">${r.profiles?.full_name||'(Sin nombre)'}<div class="text-slate-500 text-xs">${r.profiles?.email||''}</div></td>
    <td><button class="btn" data-add="${r.user_id}">Asignar</button></td>`;
    body.appendChild(tr);
  });

  // asignados
  const { data: assigned } = await supabase.from('assignments').select('id,user_id,status,profiles(full_name,email)').eq('day',day).eq('location_id',location_id).eq('shift_label',shift_label).order('created_at');
  const as=$$('#assigned'); as.innerHTML='';
  (assigned||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="py-2">${r.profiles?.full_name||'(Sin nombre)'}<div class="text-slate-500 text-xs">${r.profiles?.email||''}</div></td>
    <td><span class="chip">${r.status}</span></td>
    <td class="space-x-2">
      <button class="text-emerald-700" data-confirm="${r.id}">Confirmar</button>
      <button class="text-red-700" data-del="${r.id}">Quitar</button>
      <button class="btn" data-send="${r.user_id}">Finalizar y enviar</button>
    </td>`;
    as.appendChild(tr);
  });

  // listeners
  $$$('#pool [data-add]').forEach(b=> b.addEventListener('click', ()=> addAssignment(b.dataset.add, day, location_id, shift_label)));
  $$$('#assigned [data-confirm]').forEach(b=> b.addEventListener('click', ()=> updateAssignmentStatus(parseInt(b.dataset.confirm), 'confirmado').then(loadAdminPool)));
  $$$('#assigned [data-del]').forEach(b=> b.addEventListener('click', ()=> deleteAssignment(parseInt(b.dataset.del)).then(loadAdminPool)));
  $$$('#assigned [data-send]').forEach(b=> b.addEventListener('click', ()=> sendAsignacion(b.dataset.send, day, location_id, shift_label)));
}

async function addAssignment(user_id, day, location_id, shift_label){
  const { data: cap } = await supabase.from('vacancy_status').select('*').eq('day',day).eq('location_id',location_id).eq('shift_label',shift_label).maybeSingle();
  if(cap && cap.disponibles<=0) return alert('No hay cupos disponibles.');
  await supabase.from('assignments').insert({ user_id, day, location_id, shift_label, status:'propuesto', created_by: sessionUser.id });
  await loadAdminPool();
}
async function updateAssignmentStatus(id,status){ return supabase.from('assignments').update({ status }).eq('id', id); }
async function deleteAssignment(id){ return supabase.from('assignments').delete().eq('id', id); }

async function exportCSV(){
  const day=$$('#admDay').value; const location_id=parseInt($$('#admLocation').value); const shift_label=$$('#admShift').value;
  const { data } = await supabase.from('assignments').select('day,shift_label,status,profiles(full_name,email),locations(name)').eq('day',day).eq('location_id',location_id).eq('shift_label',shift_label);
  const rows=[['Fecha','Ubicaci√≥n','Turno','Nombre','Email','Estado']].concat((data||[]).map(r=>[r.day,r.locations?.name||'',r.shift_label,r.profiles?.full_name||'',r.profiles?.email||'',r.status]));
  const csv = rows.map(r=>r.map(x=>`"${String(x||'').replaceAll('"','""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`asignaciones_${day}_${location_id}_${shift_label}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* ============== PDF GENERATORS ============== */
function headerPDF(doc, title){
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text(title, 14, 18);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text('CRM Vacantes ‚Äî AGN', 14, 25);
  doc.line(14, 28, 196, 28);
}

function kv(doc, k, v, x, y){ doc.setFont('helvetica','bold'); doc.text(`${k}:`, x, y); doc.setFont('helvetica','normal'); doc.text(String(v||'-'), x+28, y); }

function genPDFSolicitud({ profile, bloques }){
  const { jsPDF } = window.jspdf; const doc = new jsPDF();
  headerPDF(doc, 'SOLICITUD DE SERVICIOS');
  let y = 36;
  kv(doc,'Nombre',profile.full_name,14,y);  y+=6;
  kv(doc,'DNI',profile.dni,14,y);           y+=6;
  kv(doc,'CUIL',profile.cuil,14,y);         y+=6;
  kv(doc,'Tel√©fono',profile.phone,14,y);    y+=6;
  kv(doc,'Direcci√≥n',profile.address,14,y); y+=6;
  kv(doc,'Ciudad',profile.city,14,y);       y+=10;

  doc.setFont('helvetica','bold'); doc.text('D√çAS SOLICITADOS', 14, y); y+=4;
  doc.setFont('helvetica','normal');
  bloques.forEach(b=>{
    if(!b.dias || !b.dias.length) return;
    doc.text(`‚Ä¢ ${b.sede} ‚Äî Turno ${b.turno}`, 14, y); y+=5;
    const lines = b.dias.join(', ');
    const chunk = doc.splitTextToSize(lines, 180);
    doc.text(chunk, 18, y); y += (chunk.length*5)+2;
  });

  y += 8;
  doc.text('Declaro que la informaci√≥n proporcionada es verdadera.', 14, y); y+=14;
  doc.text('Firma del solicitante: ____________________________', 14, y);

  const fname = `Solicitud_${(profile.full_name||'usuario').replace(/\s+/g,'_')}.pdf`;
  doc.save(fname);
}

async function sendAsignacion(user_id, day, location_id, shift_label){
  // traer perfil y todas las asignaciones confirmadas del usuario (d√≠a actual por simplicidad)
  const { data: prof } = await supabase.from('profiles').select('*').eq('id', user_id).maybeSingle();
  const { data: rows } = await supabase.from('assignments').select('day,shift_label,status,locations(name)').eq('user_id',user_id).eq('day',day).eq('location_id',location_id).eq('shift_label',shift_label).in('status',['propuesto','confirmado']).order('day');

  const { jsPDF } = window.jspdf; const doc = new jsPDF();
  headerPDF(doc, 'ASIGNACI√ìN DE SERVICIOS');
  let y=36;
  kv(doc,'Nombre',prof?.full_name,14,y);  y+=6;
  kv(doc,'DNI',prof?.dni,14,y);           y+=6;
  kv(doc,'CUIL',prof?.cuil,14,y);         y+=6;
  kv(doc,'Email',prof?.email,14,y);       y+=10;

  doc.setFont('helvetica','bold'); doc.text('DETALLE DE ASIGNACIONES', 14, y); y+=6;
  doc.setFont('helvetica','normal');
  (rows||[]).forEach(r=>{
    doc.text(`‚Ä¢ ${r.day} ‚Äî ${r.locations?.name||''} ‚Äî ${r.shift_label} ‚Äî Estado: ${r.status}`, 14, y);
    y+=6;
  });

  y+=10;
  doc.text(`Firmado digitalmente por AGN ‚Äî ${iso(new Date())}`, 14, y); y+=6;
  doc.text('Este documento fue generado autom√°ticamente por el sistema.', 14, y);

  const fname = `Asignacion_${(prof?.full_name||'usuario').replace(/\s+/g,'_')}_${day}.pdf`;
  doc.save(fname);
}
</script>
</body>
</html>
